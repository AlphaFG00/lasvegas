define("odsp-next/dataSources/upload/odc/BatchUploader",["require","exports","tslib","../BatchUploader","./FallbackSingleFileUploader","./SingleFileUploader","./Html5FileUpload","../vroom/SingleFileUploader","../../../utilities/features/Features","@ms/odsp-utilities/lib/file/FileUploadType","../../../actions/odc/SkyApiHelper","./UploadConstants","@ms/odsp-utilities/lib/resources/Resources"],function(e,t,r,a,i,n,s,l,u,d,p,c,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var m=function(o){r.__extends(e,o);function e(e,t){var r=o.call(this,e,t)||this;r.maxFileSize=c.UPLOAD_SIZE_LIMIT_IN_BYTES;r._legacyHtml5FileUploadType=t.legacyHtml5FileUploadType;r._singleFileUploaderType=t.singleFileUploaderType;r._vroomSingleFileUploaderType=t.vroomSingleFileUploaderType;r._fallbackSingleFileUploaderType=t.fallbackSingleFileUploaderType;r._itemToRedeem=e.item||e.parentItem;return r}e.prototype.beforeStart=function(){return p.tryAutoRedeemItem(this._itemToRedeem,{name:"UploadManager",resources:this.resources}).then(function(){})};e.prototype.createSingleFileUploader=function(e){var t=e.fileUpload,r=e.parentItem;return u.isFeatureEnabled(u.UseFallbackUploader)?new(this.scope.attached(this._fallbackSingleFileUploaderType))({fileUpload:t,parentItem:r,batchStartTime:this.batchStartTime,wasDragAndDropped:this.wasDragAndDropped}):u.isFeatureEnabled(u.UseVroomUpload)?new(this.scope.attached(this._vroomSingleFileUploaderType))({fileUpload:t,parentItem:r,qosContext:{uploadType:d.Html5,isDragAndDrop:this.wasDragAndDropped,isFolderUpload:!0}}):new(this.scope.attached(this._singleFileUploaderType))({fileUpload:new this._legacyHtml5FileUploadType({fileUpload:t,wasDragAndDropped:this.wasDragAndDropped}),parentItem:r,qosContext:{batchStartTime:this.batchStartTime,folderUpload:!0}})};e.dependencies=r.__assign({},a.default.dependencies,{legacyHtml5FileUploadType:s.typeResourceKey,singleFileUploaderType:n.typeResourceKey,vroomSingleFileUploaderType:l.resourceKey,fallbackSingleFileUploaderType:i.typeResourceKey});return e}(a.default);t.default=m;t.typeResourceKey=o.createResolvedTypeResourceKey(e("module").id,m)});define("odsp-next/dataSources/upload/BatchUploader",["require","exports","tslib","@ms/odsp-shared/lib/base/BaseModel","@ms/odsp-utilities/lib/async/Semaphore","@ms/odsp-utilities/lib/async/Promise","@ms/odsp-utilities/lib/async/Signal","@ms/odsp-datasources/lib/dataSources/upload/UploadError","@ms/odsp-utilities/lib/logging/events/Qos.event","./SingleFolderUploader","@ms/odsp-datasources/lib/dataSources/upload/Upload","./SingleErrorUploader","./Html5FileUpload","@ms/odsp-utilities/lib/file/FileEntries","../../utilities/features/Features","./UploadQosMonitor"],function(e,t,r,o,n,l,s,u,d,a,p,c,m,f,h,y){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(i){r.__extends(e,i);function e(e,t){var r=i.call(this,{},t)||this,o=e.batchStartTime,a=void 0===o?Date.now():o;r.filesUploading=r.observables.createArray();r.wasDragAndDropped=e.wasDragAndDropped;r.parentItem=e.parentItem;r._behavior=e.behavior;r._fileList=e.files;r.batchStartTime=a;r._fileReader=new FileReader;r._fileReaderQueue=new n.default;r._startUploadQueue=new n.default;r._html5FileUploadType=t.html5FileUploadType;r._singleErrorUploaderType=t.singleErrorUploaderType;r._singleFolderUploaderType=t.singleFolderUploaderType;r._uploadQosMonitorType=t.uploadQosMonitorType;return r}e.prototype.start=function(){var o=this,e=new d.Qos({name:"BatchUploader.start"});return this.beforeStart().then(function(){var e,t,r=o._fileList;e=(t=r[0])&&"function"==typeof(t.slice||t.mozSlice||t.webkitSlice)&&"size"in t?f.buildEntriesFromFileList(r):f.buildEntriesFromEntryList(r);return l.default.all(e.map(function(e,t){return o._getUpload(e,o.parentItem,t)})).then(function(e){return l.default.all(e.map(function(e){return e.wait}))}).then(function(){})}).then(function(){e.end({resultType:d.ResultTypeEnum.Success});o.onBatchComplete()},function(){e.end({resultType:d.ResultTypeEnum.Failure});o.onBatchComplete()})};e.prototype.beforeStart=function(){return l.default.wrap()};e.prototype.validateFile=function(e){return l.default.wrap()};e.prototype.onBatchComplete=function(){};e.prototype.isSPList=function(){return!1};e.prototype.libraryName=function(){return""};e.prototype._isFolder=function(r){var o=this,a=this._fileReader;return this._fileReaderQueue.enqueue(function(){var t=new s.default;o.events.on(a,"load",function(){t.complete(!1)});o.events.on(a,"error",function(){t.complete(!0)});var e=r.slice||r.mozSlice||r.webkitSlice;try{a.readAsArrayBuffer(e.call(r,0,Math.min(1,r.size)))}catch(e){t.complete(!0)}return t.getPromise().then(function(e){o.events.off(a);return e})})};e.prototype._getUpload=function(e,t,r){var o=this,a=new d.Qos({name:"BatchUploader.getUpload"});return this._startUploadQueue.enqueue(function(){var e,t=new s.default(function(){e&&o.async.clearTimeout(e)});e=o.async.setTimeout(function(){return t.complete()},0);return t.getPromise()}).then(function(){return 2===e.type?o._getDirectoryUpload(e,t):o._getUnknownUpload(e,t,r)}).then(function(e){a.end({resultType:d.ResultTypeEnum.Success});return e},function(e){a.end({resultType:d.ResultTypeEnum.Failure});return l.default.wrapError(e)})};e.prototype._getUploadsForDirectoryPage=function(e,r,o){var a=this,t=e.entries,i=[l.default.all(t.map(function(e,t){return a._getUpload(e,r,o+t)}))];e.getEntries&&i.push(e.getEntries().then(function(e){return a._getUploadsForDirectoryPage(e,r,o+t.length)}));return l.default.all(i).then(function(e){return[].concat.apply([],e)})};e.prototype._getDirectoryUpload=function(e,t){var r=this,o=new s.default,a=new(this.scope.attached(this._singleFolderUploaderType))({name:e.name,parentItem:t,onCreateFolder:function(t){return e.getEntries().then(function(e){return r._getUploadsForDirectoryPage(e,t,0)}).then(function(e){o.complete(e)},function(e){o.error(e)})}}),i={wait:this._waitForUploader(a).then(function(){return o.getPromise()}).then(function(e){return l.default.all(e.map(function(e){return e.wait}))}).then(function(){})};return l.default.wrap(i)};e.prototype._getUnknownUpload=function(a,i,n){var s=this;return a.getFile().then(function(t){var e,r;e=0===a.type?s._isFolder(t).then(function(e){r=!0;if(e)return l.default.wrapError(new u.UploadError({message:"",errorType:p.UploadErrorType.folderUploadNotSupported}))}):l.default.wrap();var o=new s._html5FileUploadType({file:t});return e.then(function(){return s._validateFile({fileUpload:o})}).then(function(){return s.validateFile({fileUpload:o,parentItem:i,index:n})}).then(function(){return s.createSingleFileUploader({fileUpload:o,parentItem:i,index:n,isTemplate:s.isTemplate})},function(e){return new(s.scope.attached(s._singleErrorUploaderType))({name:t.name,parentItem:i,isFolder:r,error:e})})},function(e){return new(s.scope.attached(s._singleErrorUploaderType))({name:a.name,parentItem:i,isFolder:!1,error:new u.UploadError({errorType:p.UploadErrorType.general,message:""})})}).then(function(e){return{wait:s._waitForUploader(e)}})};e.prototype._waitForUploader=function(t){var r=new s.default(function(){t.abort()});h.isFeatureEnabled(h.UploadQosMonitor)&&this.scope.attach(new this._uploadQosMonitorType({uploader:t,isDragDrop:this.wasDragAndDropped}));this.observables.backgroundCompute(function(){var e=t.state.peek();2===e?r.complete():4===e?r.error(t.error.peek()||new Error("Unknown error from uploader.")):3===e?r.cancel():t.state()});this._addUploader(t);t.start();return r.getPromise()};e.prototype._validateFile=function(e){var t=e.fileUpload;return t.name?t.size?void 0!==this.maxFileSize&&t.size>this.maxFileSize?l.default.wrapError(new u.UploadError({message:"",errorType:p.UploadErrorType.fileSize,maxSizeInBytes:this.maxFileSize})):l.default.wrap():l.default.wrapError(new u.UploadError({message:"",errorType:this.isSPList()?p.UploadErrorType.emptyFileOrFolderForDocLib:p.UploadErrorType.emptyFileOrFolder,libraryName:this.libraryName()})):l.default.wrapError(new u.UploadError({message:"",errorType:p.UploadErrorType.invalidName}))};e.prototype._addUploader=function(e){var t=this._behavior;t&&e.nameConflictBehavior(t);this.filesUploading.push(e);return e};e.dependencies=r.__assign({},o.default.dependencies,{html5FileUploadType:m.typeResourceKey,singleErrorUploaderType:c.typeResourceKey,singleFolderUploaderType:a.typeResourceKey,uploadQosMonitorType:y.typeResourceKey});return e}(o.default);t.default=i});define("@ms/odsp-datasources/lib/dataSources/upload/UploadError",["require","exports","tslib","./Upload","@ms/utilities-error/lib/index"],function(e,t,o,a,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(r){o.__extends(e,r);function e(e){var t=r.call(this,e)||this;t.message=e.message;t.errorType=e.errorType||a.UploadErrorType.other;t.maxSizeInBytes=e.maxSizeInBytes;t.allowRename=e.allowRename||!1;t.allowMerge=e.allowMerge||!1;t.extraData=e.extraData;t.libraryName=e.libraryName;t.isFolder=e.isFolder;t.fixItUrl=e.fixItUrl;return t}return e}(r.CustomError);t.UploadError=i;t.default=i});define("odsp-next/dataSources/upload/SingleFolderUploader",["require","exports","tslib","@ms/odsp-shared/lib/base/BaseModel","@ms/odsp-utilities/lib/async/Semaphore","@ms/odsp-datasources/lib/dataSources/upload/Upload","@ms/odsp-datasources/lib/dataSources/upload/UploadError","../../resources/DataSourceResourceKeys","@ms/odsp-utilities/lib/resources/Resources"],function(e,t,r,o,a,i,n,s,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.uploadQueueResourceKey=new l.ResourceKey({name:e("module").id+".uploadQueue",factory:{dependencies:{},create:function(){return{instance:new a.default(3)}}}});var u=function(a){r.__extends(e,a);function e(e,t){var r=a.call(this,e,t)||this;r._itemDataSource=t.itemDataSource;r._uploadQueue=t.uploadQueue;r._parentItem=e.parentItem;r._onCreateFolder=e.onCreateFolder;r.allowRename=!1;var o=r.observables;r.item=o.create();r.state=o.create(0);r.uploadedBytes=o.create(0);r.totalBytes=o.create(0);r.fileName=o.create(e.name);r.iconName=o.create("folder");r.error=o.create();r.nameConflictBehavior=o.create(0);return r}e.prototype.start=function(){this._uploadPromise=this.trackPromise(this._upload())};e.prototype.abort=function(){this.error(void 0);this.state(3);var e=this._uploadPromise;delete this._uploadPromise;e&&e.cancel()};e.prototype.restart=function(){var e=this,t=this._uploadPromise;delete this._uploadPromise;t&&t.cancel();t.then(function(){},function(){}).done(function(){e.start()})};e.prototype._upload=function(){var r=this;this.state(1);return this._uploadQueue.enqueue(function(){return r._itemDataSource.createFolder({parent:r._parentItem,folderName:r.fileName.peek(),needItemDetails:!0})}).then(function(e){r.item(e);return r._onCreateFolder(e)}).then(function(){r.state(2)},function(e){var t;t=e instanceof Error?e.message:e;r.error(new n.UploadError({errorType:i.UploadErrorType.other,message:t}));r.state(4)})};e.dependencies=r.__assign({},o.default.dependencies,{itemDataSource:s.items,uploadQueue:t.uploadQueueResourceKey});return e}(o.default);t.default=u;t.typeResourceKey=l.createResolvedTypeResourceKey(e("module").id,u)});define("odsp-next/dataSources/upload/SingleErrorUploader",["require","exports","tslib","@ms/odsp-shared/lib/base/BaseModel","@ms/odsp-utilities/lib/resources/Resources","@ms/odsp-datasources/lib/utilities/path/Path","@ms/odsp-utilities/lib/icons/IconSelector"],function(e,t,r,o,a,d,p){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(u){r.__extends(e,u);function e(e,t){var r=u.call(this,e,t)||this,o=e.name,a=e.isFolder,i=e.error;r._error=i;var n=d.getFileExtension(o),s=a?"folder":p.getIconNameFromExtension(n);r.allowRename=!1;var l=r.observables;r.item=l.create();r.state=l.create(4);r.uploadedBytes=l.create(0);r.totalBytes=l.create(0);r.fileName=l.create(o);r.iconName=l.create(s);r.error=l.create(r._error);r.nameConflictBehavior=l.create(0);return r}e.prototype.start=function(){this.error(this._error);this.state(4)};e.prototype.abort=function(){this.error(void 0);this.state(3)};e.prototype.restart=function(){this.start()};return e}(o.default);t.default=i;t.typeResourceKey=a.createResolvedTypeResourceKey(e("module").id,i)});define("odsp-next/dataSources/upload/Html5FileUpload",["require","exports","@ms/odsp-utilities/lib/file/Html5FileUpload","@ms/odsp-utilities/lib/browser/PlatformDetection.key","@ms/odsp-utilities/lib/resources/Resources"],function(e,t,r,o,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Html5FileUpload=r.Html5FileUpload;t.typeResourceKey=a.createResolvedTypeResourceKey(e("module").id,r.Html5FileUpload,{platformDetection:o.platformDetection});t.default=r.Html5FileUpload});define("@ms/odsp-utilities/lib/file/Html5FileUpload",["require","exports","../icons/IconSelector","../path/Path"],function(e,t,d,p){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var c=0,r=function(){function e(e,t){var r=e.file;this._file=r;this.eTag=r.eTag;var o,a=r.fileName||r.name,i=p.splitFileName(a),n=i.name,s=i.extension;this.extension=s;this.iconName=d.getIconNameFromExtension(s);this.size=r.size;if(t.platformDetection.isIOS&&"image"===n&&"photo"===this.iconName){var l=r.lastModifiedDate,u=void 0===l?new Date:l;o="IMG_"+this._getLastModifiedISO8601(u)+"_"+ ++c+s}else o=a;r.lastModifiedDate&&(this.lastModifiedDate=r.lastModifiedDate);this.name=o}e.prototype.slice=function(e,t){var r=this._file;return(r.slice||r.mozSlice||r.webkitSlice).call(r,e,t)};e.prototype._getLastModifiedISO8601=function(e){return e.getUTCFullYear()+"-"+o(e.getUTCMonth()+1,2)+"-"+o(e.getUTCDate(),2)+" "+o(e.getUTCHours(),2)+"-"+o(e.getUTCMinutes(),2)+"-"+o(e.getSeconds(),2)};return e}();t.Html5FileUpload=r;function o(e,t){for(var r=""+e;r.length<t;)r="0"+r;return r}t.default=r});define("@ms/odsp-utilities/lib/file/FileEntries",["require","exports","../async/Signal","../async/Promise"],function(e,t,r,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});!function(e){e[e.unknown=0]="unknown";e[e.file=1]="file";e[e.directory=2]="directory"}(t.EntryType||(t.EntryType={}));function n(e){return{name:e.name,type:2,getEntries:function(){return o.default.resolve({entries:d(e)})}}}function s(e){return e.type?{name:e.name,type:1,getFile:function(){return o.default.resolve(e)}}:{name:e.name,type:0,getFile:function(){return o.default.resolve(e)}}}function d(e){var t=[];for(var r in e.directories)r&&t.push(n(e.directories[r]));for(var o=0,a=e.files;o<a.length;o++){var i=a[o];t.push(s(i))}return t}t.buildEntriesFromFileList=function(e){for(var t={name:"",directories:{},files:[]},r=0,o=e;r<o.length;r++){for(var a=o[r],i=a.webkitRelativePath,n=t,s=0,l=(void 0===i?a.name:i).split("/").slice(0,-1);s<l.length;s++){var u=l[s];n=n.directories[u]||(n.directories[u]={name:u,directories:{},files:[]})}n.files.push(a)}return d(t)};function a(t){return function(e){var t=new r.default;e.readEntries(function(e){return t.complete(e)},function(e){return t.error(e)});return t.getPromise()}(t).then(function(e){return e.length?{entries:e.map(i),getEntries:function(){return a(t)}}:{entries:[]}})}function i(e){var t;e.isDirectory?t={name:e.name,type:2,getEntries:function(){return a(e.createReader())}}:e.isFile&&(t={name:e.name,type:1,getFile:function(){return function(e){var t=new r.default;e.file(function(e){t.complete(e)},function(e){t.error(e)});return t.getPromise()}(e)}});return t}t.buildEntriesFromEntryList=function(e){return e.map(i)}});define("odsp-next/dataSources/upload/UploadQosMonitor",["require","exports","tslib","@ms/odsp-shared/lib/base/BaseModel","@ms/odsp-shared/lib/utilities/logging/events/Upload.event","@ms/odsp-datasources/lib/dataSources/upload/Upload","@ms/odsp-utilities/lib/resources/Resources","@ms/odsp-utilities/lib/path/Path"],function(e,t,r,o,a,i,n,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var l=0,u=function(o){r.__extends(e,o);function e(e,t){var r=o.call(this,e,t)||this;r._uploader=e.uploader;r._isDragDrop=e.isDragDrop;r._id=++l;r._sequence=0;r.observables.backgroundCompute(r._computeUpdateQos);return r}e.prototype._computeUpdateQos=function(){var e=this._uploader,t=e.state.peek();if(0===t){this._uploadEvent=void 0;e.state()}else if(1===t){this._uploadEvent=this._createUploadEvent();e.state()}else if(2===t){(this._uploadEvent||(this._uploadEvent=this._createUploadEvent())).end({resultType:a.ResultTypeEnum.Success})}else if(4===t){var r=e.error.peek();(this._uploadEvent||(this._uploadEvent=this._createUploadEvent())).end({resultType:function(e){switch(e.errorType){case i.UploadErrorType.conflict:case i.UploadErrorType.emptyFileOrFolder:case i.UploadErrorType.emptyFileOrFolderForDocLib:case i.UploadErrorType.fileSize:case i.UploadErrorType.folderUploadNotSupported:case i.UploadErrorType.invalidName:case i.UploadErrorType.lockMismatch:case i.UploadErrorType.malwareDetected:case i.UploadErrorType.overQuota:case i.UploadErrorType.overQuotaSharedFolder:case i.UploadErrorType.throttled:case i.UploadErrorType.versionMismatch:return!0;default:case i.UploadErrorType.authFailure:case i.UploadErrorType.accessDenied:case i.UploadErrorType.general:case i.UploadErrorType.none:case i.UploadErrorType.other:case i.UploadErrorType.targetFolderMissing:return!1}}(r)?a.ResultTypeEnum.ExpectedFailure:a.ResultTypeEnum.Failure,resultCode:i.UploadErrorType[r.errorType]});e.state()}else if(3===t){(this._uploadEvent||(this._uploadEvent=this._createUploadEvent())).end({resultType:a.ResultTypeEnum.ExpectedFailure,resultCode:"canceled"})}};e.prototype._createUploadEvent=function(){return new a.default({name:"BatchUploader.uploadSingleItem",dragAndDrop:this._isDragDrop,size:this._uploader.totalBytes.peek(),extension:s.getFileExtension(this._uploader.fileName.peek(),!0),folderUpload:"folder"===this._uploader.iconName.peek(),groupFolder:!1,extraData:{uploadId:this._id,uploadAttemptCount:++this._sequence}})};return e}(o.default);t.UploadQosMonitor=u;t.typeResourceKey=n.createResolvedTypeResourceKey(e("module").id,u,{})});define("@ms/odsp-shared/lib/utilities/logging/events/Upload.event",["require","exports","@ms/odsp-utilities/lib/logging/PairedEventBase","@ms/odsp-utilities/lib/logging/events/Qos.event","@ms/odsp-utilities/lib/logging/events/ResultTypeEnum"],function(e,t,r,o,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.ResultTypeEnum=a.ResultTypeEnum;t.Upload=r.createPairedEvent({eventName:"Upload,Qos,",shortEventName:"Upload"},{dragAndDrop:3,size:2,extension:1,folderUpload:3,groupFolder:3},o.Qos);t.default=t.Upload});define("odsp-next/dataSources/upload/odc/FallbackSingleFileUploader",["require","exports","tslib","@ms/odsp-shared/lib/base/BaseModel","@ms/odsp-datasources/lib/dataSources/upload/Upload","@ms/odsp-utilities/lib/file/FileUploadType","./SingleFileUploader","./Html5FileUpload","../vroom/SingleFileUploader","@ms/odsp-utilities/lib/resources/Resources"],function(e,t,r,o,a,f,i,n,s,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var u=function(m){r.__extends(e,m);function e(e,t){var r=m.call(this,e,t)||this;r.allowRename=!0;var o=r,a=o.observables,i=o.scope,n=e.fileUpload,s=e.parentItem,l=e.wasDragAndDropped,u=e.batchStartTime,d=t.singleFileUploaderType,p=t.vroomSingleFileUploaderType,c=t.legacyHtml5FileUploadType;r._started=a.create(!1);r._createVroomSingleFileUploader=function(){return i.attach(new p({fileUpload:n,parentItem:s,qosContext:{uploadType:f.Html5,isDragAndDrop:l,isFolderUpload:!0}}))};r._createLegacySingleFileUploader=function(){return i.attach(new d({parentItem:s,fileUpload:new c({fileUpload:n,wasDragAndDropped:l}),qosContext:{batchStartTime:u,folderUpload:!0}}))};r._uploader=a.pureCompute(r._computeUploader);r.totalBytes=a.pureCompute(r._computeTotalBytes);r.uploadedBytes=a.pureCompute(r._computeUploadedBytes);r.fileName=a.pureCompute(r._computeFileName);r.iconName=a.pureCompute(r._computeIconName);r.state=a.pureCompute(r._computeState);r.error=a.pureCompute(r._computeError);r.nameConflictBehavior=a.compute({read:r._computeNameConflictBehavior,write:r._setNameConflictBehavior,pure:!0});r.item=a.pureCompute(r._computeItem);a.compute(r._computeStartUploader);return r}e.prototype.start=function(){this._started(!0)};e.prototype.restart=function(){this._uploader.peek().restart()};e.prototype.abort=function(){this._uploader.peek().abort()};e.prototype._computeTotalBytes=function(){return this._uploader().totalBytes()};e.prototype._computeUploadedBytes=function(){return this._uploader().uploadedBytes()};e.prototype._computeFileName=function(){return this._uploader().fileName()};e.prototype._computeIconName=function(){return this._uploader().iconName()};e.prototype._computeState=function(){return this._uploader().state()};e.prototype._computeError=function(){return this._uploader().error()};e.prototype._computeNameConflictBehavior=function(){return this._uploader().nameConflictBehavior()};e.prototype._setNameConflictBehavior=function(e){this._uploader.peek().nameConflictBehavior(e)};e.prototype._computeItem=function(){return this._uploader().item()};e.prototype._computeUploader=function(){var e=this._uploader.peek();e||(e=this._createVroomSingleFileUploader());var t=e.error.peek();if(t&&t.errorType===a.UploadErrorType.accessDenied){var r=e.nameConflictBehavior.peek();(e=this._createLegacySingleFileUploader()).nameConflictBehavior(r)}else e.error();return e};e.prototype._computeStartUploader=function(){var e=this._uploader();this._started()&&e.start()};return e}(o.default);t.FallbackSingleFileUploader=u;t.typeResourceKey=l.createResolvedTypeResourceKey(e("module").id,u,r.__assign({},o.default.dependencies,{vroomSingleFileUploaderType:s.resourceKey,legacyHtml5FileUploadType:n.typeResourceKey,singleFileUploaderType:i.typeResourceKey}))});define("@ms/odsp-utilities/lib/file/FileUploadType",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Html5="h5"});define("odsp-next/dataSources/upload/odc/SingleFileUploader",["require","exports","tslib","@ms/odsp-shared/lib/base/BaseModel","knockout","@ms/odsp-utilities/lib/object/ObjectUtil","@ms/odsp-utilities/lib/async/Promise","@ms/odsp-utilities/lib/async/Signal","@ms/odsp-utilities/lib/async/Retry","@ms/odsp-utilities/lib/async/Semaphore","@ms/odsp-datasources/lib/dataSources/upload/Upload","../../../resources/ODCResourceKeys","../../url/odc/UrlDataSource","@ms/odsp-datasources/lib/dataSources/upload/UploadError","./UploadLogger","./FileUploaderStateMachine","./UploadConstants","../../base/odc/ItemResultProcessor","../../item/ItemTaskObserver","@ms/odsp-utilities/lib/path/Path","@ms/odsp-utilities/lib/resources/Resources"],function(e,t,r,o,m,n,f,d,h,a,y,i,_,v,g,S,U,T,E,b,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var R=window.FilesConfig&&window.FilesConfig.appId,F={sl:10240,h5:102400},u={sl:10485760,h5:104857600},w={sl:2e3,h5:2e3},l=function(p){r.__extends(c,p);function c(e,t){var r=p.call(this,e,t)||this,o=e.fileUpload,a=e.parentItem,i=e.qosContext,n=void 0===i?{}:i,s=n.batchStartTime,l=void 0===s?void 0:s,u=n.folderUpload,d=void 0!==u&&u;r._urlDataSource=t.urlDataSource;r._fileUpload=o;r._currentChunkSize=10*F[r._fileUpload.upType];r._parentItem=a;r.allowRename=!0;r._uploadLogger=new g.default;r._machine=new S.default({enqueue:function(e){r.state(0);return c._uploadQueue.enqueue(e)},upload:function(){r.error(null);r.state(1);r.uploadedBytes(0);r._uploadLogger.start(r._parentItem,r._fileUpload);return r.startUpload()},aborted:function(){r.abortSession();r._uploadLogger.abort();r.dispose();r.error(null);r.state(3)},failed:function(e){var t=U.ERROR_TYPE_MAPPINGS[e]||y.UploadErrorType.general;t===y.UploadErrorType.overQuota&&_.default.viewerId.toLowerCase()!==r._parentItem.uploadOwnerId.toLowerCase()&&(t=y.UploadErrorType.overQuotaSharedFolder);r.error(new v.UploadError({message:"",errorType:t,maxSizeInBytes:U.UPLOAD_SIZE_LIMIT_IN_BYTES,allowRename:r.allowRename}));r.state(4);r._uploadLogger.fail(e)},completed:function(){r._uploadLogger.complete();r.dispose();r.state(2)}});r._instrumentationValues={upType:o.upType,dragDrop:o.dragDrop,SourceId:"SkyApi:"+R,size:o.size,fileType:o.extension.replace(".",""),batchId:""+l,folderUpload:d};r.totalBytes=m.observable(o.size);r.uploadedBytes=m.observable(0);r.fileName=m.observable(o.name);r.iconName=m.observable(o.iconName);r.state=m.observable(0);r.error=m.observable(null);r.nameConflictBehavior=m.observable(0);r.item=r.createObservable();r._itemTaskObserver=new t.itemTaskObserverType;r._itemResultProcessor=new(r.managed(T.default));return r}c.prototype.start=function(){this._machine.start()};c.prototype.abort=function(){this._machine.abort()};c.prototype.restart=function(){this._machine.restart()};c.prototype.dispose=function(){var e=this.isDisposed;e||this.error(null);p.prototype.dispose.call(this);if(!e){delete this._fileUpload;delete this._uploadLogger;delete this._instrumentationValues}};c.prototype.updateChunkSize=function(e,t,r,o){var a=this._fileUpload.upType,i=(o-r)/((new Date).getTime()-t),n=this._currentChunkSize;if(e){var s=Math.round(w[a]*i);n=Math.max(Math.min(s,u[a]),F[a])}else n=Math.max(n/2,F[a]);var l=n/81920;n=81920*(l=Math.ceil(l));n=Math.round(n);this._currentChunkSize=n};c.prototype.sendFileRequest=function(e,t,r,o){var s=this;this._session&&(e["BITS-Session-Id"]=this._session);e.Application="LiveFolders";e.Accept="application/wls-response-headers+json";e["X-Http-Method-Override"]="BITS_POST";var a,i=this.nameConflictBehavior();3!==i&&this._fileUpload.eTag&&(e["If-Match"]=this._fileUpload.eTag);switch(i){case 2:a="choosenewname";break;case 3:case 1:a="true";break;default:a="false"}e.Overwrite=a;e["Content-Type"]="application/octet-stream";e["X-RequestStats"]=n.serialize(this._instrumentationValues,",");var l=new d.default,u=this.async.setTimeout(function(){l.error({"X-ClientErrorCode":"Timeout"})},6e4);this._fileUpload.post(this._urlDataSource.getUploadStorageUrl(this._parentItem,this._fileUpload.name),t,r,e,o).then(function(e){s.async.clearTimeout(u);if(!e||"200"!==e.StatusCode&&"201"!==e.StatusCode)e?l.error(e):l.error({"X-ClientErrorCode":"Empty"});else{if(e["X-Resource-Id"]){var t=b.splitFileName(s._fileUpload.name),r=t.name,o=t.extension,a=s._itemTaskObserver,i=s._itemResultProcessor.processItemResult({requestKey:s._parentItem.key,isPlaceholder:!0,itemFromServer:{id:e["X-Resource-Id"],ownerCid:_.default.viewerId,name:r,extension:o},isPrimaryRequestedItem:!0,observer:a}).item.key;a.update([new E.Task(i).succeed({item:{key:i,parentKey:s._parentItem.key}})]);a.flush();var n=a.getItem({key:i});s.item(n)}l.complete(e)}},function(e){s.async.clearTimeout(u);l.error(e)});return l.getPromise()};c.prototype.canRetry=function(e){var t=!0;if(e)switch(this.getErrorCode(e)){case"InsufficientSpaceAvailable":case"QuotaLimitReached":case"BadArgument":case"InvalidPath":case"UsageRestricted":case"AccessDenied":case"RelationshipNameAlreadyExists":case"ItemAlreadyExists":case"LockOwnerMismatch":case"LockMismatch":case"VersionNumberDoesNotMatch":t=!1;break;default:t=!0}return t};c.prototype.getErrorCode=function(e){var t="";e&&(t=e["X-ClientErrorCode"]);return t};c.prototype.closeSession=function(){var r=this;return h.default({async:this.async,retries:3,delay:1e4,canRetry:function(e){return r.canRetry(e)},adjustRetries:function(e){var t=3;"Offline"===r.getErrorCode(e)&&(t=60);return t},callback:function(){var e={"BITS-Packet-Type":"Close-Session"};r._fileUpload.lastModified&&(e["X-Last-Modified-ISO8601"]=r._fileUpload.lastModified);return r.sendFileRequest(e,0,0)}}).then(null,function(e){return f.default.wrapError(r.getErrorCode(e))})};c.prototype.startFragmentsUpload=function(){var t,o=this,r=this._fileUpload.size,a=0,i=Math.min(a+this._currentChunkSize,r),n=!1,s=!1,l=!1,u=!1,d=!1,p=function(e){};return h.default({async:this.async,retries:3,resetAttemptsOnRestart:!0,delay:1e4,canRetry:function(e){return o.canRetry(e)},adjustRetries:function(e){var t=3,r=o.getErrorCode(e);if("Offline"===r){n=!0;t=60}else if("Timeout"===r){l=!0;t=3}return t},shouldRestart:function(){var e=!1;n=!1;u&&(u=!(d=!0));o.uploadedBytes(i);if(i!==o._fileUpload.size){e=!0;s||d||o.updateChunkSize(!0,t,a,i);s=!1;a=i;i=Math.min(a+o._currentChunkSize,o._fileUpload.size)}return e},beforeRetry:function(){if(!n){o.updateChunkSize(!1,t,a,i);i=Math.min(a+o._currentChunkSize,o._fileUpload.size);l&&(l=!(u=!0))}},callback:function(){var e={"BITS-Packet-Type":"Fragment"};e["Content-Range"]="bytes "+a+"-"+Math.max(0,i-1)+"/"+r;t=(new Date).getTime();return o.sendFileRequest(e,a,i,p).then(void 0,function(e){if("FragmentOverlap"===o.getErrorCode(e)){s=!0;return{}}return f.default.wrapError(e)})}}).then(function(e){return o.closeSession()},function(e){return f.default.wrapError(o.getErrorCode(e))})};c.prototype.startUpload=function(){return this._fileUpload.isLocked?f.default.wrapError("LockMismatch"):this.createSession()};c.prototype.createSession=function(){var r=this;this._session="";return h.default({async:this.async,delay:1e4,retries:3,adjustRetries:function(e){var t=3;"Offline"===r.getErrorCode(e)&&(t=60);return t},callback:function(){return r.sendFileRequest({"BITS-Packet-Type":"Create-Session","BITS-Supported-Protocols":"{7df0354d-249b-430f-820d-3d2a9bef4931}"},0,0)},canRetry:function(e){return r.canRetry(e)}}).then(function(e){r._session=e["BITS-Session-Id"];return r.startFragmentsUpload()},function(e){return f.default.wrapError(r.getErrorCode(e))})};c.prototype.abortSession=function(){if(this._session){this.sendFileRequest({"BITS-Packet-Type":"Cancel-Session"},0,0).done(null,function(){})}};c.dependencies=r.__assign({},o.default.dependencies,{urlDataSource:i.urlDataSource,itemTaskObserverType:E.resourceKey});c._uploadQueue=new a.default(3);return c}(o.default);t.default=l;t.typeResourceKey=s.createResolvedTypeResourceKey(e("module").id,l)});define("odsp-next/dataSources/upload/odc/UploadLogger",["require","exports","@ms/odsp-shared/lib/utilities/logging/events/Upload.event","@ms/odsp-utilities/lib/logging/events/Qos.event"],function(e,t,o,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(){}e.prototype.start=function(e,t){if(!this._uploadEvent){for(var r=!1;e;){if(e.mountPoint){r=!0;break}e=e.parent}this._uploadEvent=new o.Upload({name:"Upload."+t.upType,dragAndDrop:t.dragDrop,size:t.size,extension:t.extension.substring(1),folderUpload:!1,groupFolder:r,extraData:{uploaderType:"ODC"}})}};e.prototype.complete=function(){if(this._uploadEvent){this._uploadEvent.end({resultType:r.ResultTypeEnum.Success});this._uploadEvent=null}};e.prototype.fail=function(e){if(this._uploadEvent){this._uploadEvent.end({resultType:r.ResultTypeEnum.Failure,resultCode:e});this._uploadEvent=null}};e.prototype.abort=function(){if(this._uploadEvent){this._uploadEvent.end({resultType:r.ResultTypeEnum.ExpectedFailure,resultCode:"Aborted"});this._uploadEvent=null}};return e}();t.default=a});define("odsp-next/dataSources/upload/odc/FileUploaderStateMachine",["require","exports","tslib","@ms/odsp-utilities/lib/async/Promise","@ms/odsp-utilities/lib/async/Signal","@ms/odsp-utilities/lib/logging/ErrorHelper"],function(e,t,r,o,a,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this.machine=e;this.uploader=e.uploader;this.uploaderState=e.uploaderState}e.prototype.enter=function(){return null};e.prototype.exit=function(){return null};e.prototype.start=function(){return null};e.prototype.restart=function(){return null};e.prototype.abort=function(){return null};return e}(),s=function(e){r.__extends(t,e);function t(){return null!==e&&e.apply(this,arguments)||this}t.prototype.start=function(){this.machine._setState(l)};return t}(n),l=function(e){r.__extends(t,e);function t(){return null!==e&&e.apply(this,arguments)||this}t.prototype.enter=function(){var e=this;this.queuePromise=this.uploader.enqueue(function(){e.machine._setState(u);return e.uploaderState.uploadSignal.getPromise()});o.default.is(this.queuePromise)||this.machine._setState(p);this.queuePromise.done(null,function(e){o.default.isCanceled(e)||i.default.log(e,"EnqueuedUploadError")})};t.prototype.abort=function(){this.queuePromise&&this.queuePromise.cancel();this.machine._setState(d)};return t}(n),u=function(e){r.__extends(t,e);function t(){return null!==e&&e.apply(this,arguments)||this}t.prototype.enter=function(){var t=this;this.canceled=!1;this.uploaderState.uploadSignal=new a.default;this.uploadPromise=this.uploader.upload();o.default.is(this.uploadPromise)||this.machine._setState(p);this.uploadPromise.done(function(){t.machine._setState(c)},function(e){if(!t.canceled){t.uploaderState.errorCode=e;t.machine._setState(p)}})};t.prototype.exit=function(){this.uploaderState.uploadSignal.complete()};t.prototype.abort=function(){this.canceled=!0;this.uploadPromise&&this.uploadPromise.cancel();this.machine._setState(d)};return t}(n),d=function(e){r.__extends(t,e);function t(){return null!==e&&e.apply(this,arguments)||this}t.prototype.enter=function(){this.uploader.aborted()};return t}(n),p=function(e){r.__extends(t,e);function t(){return null!==e&&e.apply(this,arguments)||this}t.prototype.enter=function(){this.uploader.failed(this.uploaderState.errorCode)};t.prototype.restart=function(){this.machine._setState(l)};t.prototype.abort=function(){this.machine._setState(d)};return t}(n),c=function(e){r.__extends(t,e);function t(){return null!==e&&e.apply(this,arguments)||this}t.prototype.enter=function(){this.uploader.completed()};return t}(n),m=function(){function e(e){this.uploader=e;this.uploaderState={};this._state=new s(this)}e.prototype.start=function(){this._state.start()};e.prototype.restart=function(){this._state.restart()};e.prototype.abort=function(){this._state.abort()};e.prototype._setState=function(t,e){e||this._state.exit();this._state=new t(this);try{this._state.enter()}catch(e){i.default.log(e,"StateEntryError");t!==p&&this._setState(p,!0)}};return e}();t.default=m});define("odsp-next/dataSources/upload/odc/UploadConstants",["require","exports","@ms/odsp-datasources/lib/dataSources/upload/Upload","../../../utilities/features/Features"],function(e,t,r,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=o.isFeatureEnabled(o.Enable50GBUpload)?50:20;t.UPLOAD_SIZE_LIMIT_IN_BYTES=1024*a*1024*1024;t.ERROR_TYPE_MAPPINGS={EmptyFileOrFolder:r.UploadErrorType.emptyFileOrFolder,RequestEntityTooLarge:r.UploadErrorType.fileSize,InsufficientSpaceAvailable:r.UploadErrorType.overQuota,QuotaLimitReached:r.UploadErrorType.overQuota,BadArgument:r.UploadErrorType.invalidName,InvalidPath:r.UploadErrorType.invalidName,UsageRestricted:r.UploadErrorType.accessDenied,AccessDenied:r.UploadErrorType.accessDenied,LockOwnerMismatch:r.UploadErrorType.lockMismatch,LockMismatch:r.UploadErrorType.lockMismatch,RelationshipNameAlreadyExists:r.UploadErrorType.conflict,ItemAlreadyExists:r.UploadErrorType.conflict,VersionNumberDoesNotMatch:r.UploadErrorType.versionMismatch,FolderUploadNotSupported:r.UploadErrorType.folderUploadNotSupported}});define("odsp-next/dataSources/upload/odc/Html5FileUpload",["require","exports","../../../utilities/features/Features","@ms/odsp-utilities/lib/file/FileUploadType","../../base/odc/DataRequest","@ms/odsp-utilities/lib/async/Promise","@ms/odsp-utilities/lib/resources/Resources"],function(e,t,l,i,u,r,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e){var t=e.fileUpload,r=e.wasDragAndDropped,o=void 0!==r&&r;this._fileUpload=t;this.name=t.name;this.extension=t.extension;this.iconName=t.iconName;this.size=t.size;this.eTag=t.eTag;var a=t.lastModifiedDate;a&&(this.lastModified=a.toISOString());this.upType=i.Html5;this.dragDrop=o;this.isLocked=!1}e.prototype.isFolder=function(){return r.default.wrap(!1)};e.prototype.post=function(e,t,r,o,a){var i=o["BITS-Packet-Type"],n=void 0===i?"Unknown":i,s=!l.isFeatureEnabled(l.EnableUploadLogging);return(new u.default).send({apiName:"Upload.HTML5."+n,url:e,requestType:"POST",postData:this._fileUpload.slice(t,r),headers:o,progressCallback:a,disableLogging:s}).then(null,function(e){return 0===e.status?{"X-ClientErrorCode":"Offline"}:e.data})};return e}();t.LegacyHtml5FileUpload=a;t.typeResourceKey=new o.ResourceKey({name:""+e("module").id,factory:new o.ConstantResourceFactory(a)});t.default=a});define("odsp-next/dataSources/upload/vroom/SingleFileUploader",["require","exports","tslib","@ms/odsp-shared/lib/base/BaseModel","@ms/odsp-datasources/lib/dataSources/upload/Upload","@ms/odsp-datasources/lib/dataSources/upload/UploadError","@ms/odsp-shared/lib/utilities/logging/events/Upload.event","@ms/odsp-utilities/lib/async/Promise","@ms/odsp-utilities/lib/async/Signal","@ms/odsp-utilities/lib/async/Semaphore","@ms/odsp-graph/lib/Models","@ms/odsp-utilities/lib/resources/Resources","./VroomUploader","../../../resources/DataSourceResourceKeys","../../base/vroom/ItemResultProcessor","../../item/ItemTaskObserver","@ms/odsp-utilities/lib/logging/ErrorHelper"],function(e,t,s,r,l,i,u,d,p,o,c,a,n,m,f,h,y){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.uploadQueueResourceKey=new a.ResourceKey({name:e("module").id+".uploadQueue",factory:{dependencies:{},create:function(){return{instance:new o.default(3)}}}});var _=0,v=function(a){s.__extends(e,a);function e(e,t){var r=a.call(this,e,t)||this,o=e.fileUpload;r._qosData={uploadId:""+ ++_,uploaderType:"Vroom"};r._vroomUploader=t.vroomUploader;r._uploadQueue=t.uploadQueue;r._graphDataSource=t.graphDataSource;r._itemResultProcessor=t.itemResultProcessor;r._itemTaskObserver=new t.itemTaskObserverType;r._parentItem=e.parentItem;r._fileUpload=o;r._qosContext=e.qosContext;r.state=r.createObservable(0);r.uploadedBytes=r.createObservable(0);r.totalBytes=r.createObservable(o.size);r.fileName=r.createObservable(o.name);r.iconName=r.createObservable(o.iconName);r.error=r.createObservable();r.nameConflictBehavior=r.createObservable(0);r.allowRename=!0;r.item=r.createObservable();return r}e.prototype.start=function(){this._uploadPromise=this.trackPromise(this._upload())};e.prototype.abort=function(){delete this._fileUpload;var e=this._pendingRestart;delete this._pendingRestart;if(e)e.cancel();else{var t=this._uploadPromise;delete this._uploadPromise;if(t){t.cancel();t.done(function(){},function(){})}}};e.prototype.restart=function(){var e=this,t=this._pendingRestart;delete this._pendingRestart;if(t)t.complete();else{var r=this._uploadPromise;delete this._uploadPromise;if(r){r.cancel();r.done(function(){e.start()},function(){e.start()})}}};e.prototype._upload=function(){var i=this,t=this._fileUpload;this.uploadedBytes(0);this.error(void 0);if(!t){this.state(4);return d.default.wrap()}this.state(0);var e=this._qosContext,n=new u.Upload({name:"Upload."+e.uploadType,size:t.size,extension:t.extension.substring(1),dragAndDrop:e.isDragAndDrop,folderUpload:e.isFolderUpload,groupFolder:!1,extraData:this._qosData});return this._enqueue().then(function(){i.state(1);var e=i._parentItem;return i._vroomUploader.upload({qosData:i._qosData,itemUrl:i._graphDataSource.getItemUrl(e,{useDirectEndpoint:!0,isPath:!0}),accessToken:i._graphDataSource.getAccessToken(e),fileName:t.name,content:t,lastModifiedDate:t.lastModifiedDate,eTag:t.eTag,conflictBehavior:g(i.nameConflictBehavior.peek()),onProgress:i.async.debounce(function(e){e>i.uploadedBytes.peek()&&i.uploadedBytes(e)},100,{leading:!1}),onPromptForConfictBehavior:function(e){return i._promptForConflictBehavior(e)},onWait:function(e){return i._wait(e)}})}).then(function(e){i._dequeue();return e},function(e){i._dequeue();return d.default.wrapError(e)}).then(function(e){var t=i._itemTaskObserver,r=i._itemResultProcessor.processItem({itemFromServer:e,requestKey:i._parentItem.key,observer:t}).key;t.update([new h.Task(r).succeed({item:{key:r,parentKey:i._parentItem.key}})]);t.flush();var o=t.getItem({key:r});".txt"===o.extension&&i.fileName(""+o.displayName+o.extension);i.item(o)}).then(function(){i.uploadedBytes(t.size);delete i._fileUpload;i.error(void 0);i.state(2);n.end({resultType:u.ResultTypeEnum.Success})},function(e){if(d.default.isCanceled(e)){var t=i.state.peek();i.error(void 0);i.state(3);var r=void 0;switch(t){case 0:r="Dequeued";break;case 4:r="Ignored";break;default:r="Aborted"}n.end({resultType:u.ResultTypeEnum.ExpectedFailure,resultCode:r,extraData:s.__assign({},i._qosData,{lastByte:i.uploadedBytes.peek()})})}else{c.isGraphError(e)||y.default.logError(e);var o=i._getUploadError(e),a=o.errorType;i.error(o);i.state(4);n.end({resultType:function(e){switch(e){case l.UploadErrorType.conflict:case l.UploadErrorType.pathTooLong:case l.UploadErrorType.invalidName:case l.UploadErrorType.folderUploadNotSupported:case l.UploadErrorType.emptyFileOrFolder:case l.UploadErrorType.emptyFileOrFolderForDocLib:case l.UploadErrorType.lockMismatch:case l.UploadErrorType.overQuota:case l.UploadErrorType.fileSize:return!0;default:return!1}}(a)?u.ResultTypeEnum.ExpectedFailure:u.ResultTypeEnum.Failure,resultCode:l.UploadErrorType[a],error:o.message,extraData:s.__assign({},i._qosData,o.extraData,{lastByte:i.uploadedBytes.peek()})})}return d.default.wrapError(e)})};e.prototype._promptForConflictBehavior=function(e){var t=this;this._dequeue();var r=new p.default;this._pendingRestart=r;var o=e?this._getUploadError(e):new i.UploadError({message:"",errorType:l.UploadErrorType.conflict,allowRename:this.allowRename});this.error(o);this.state(4);return r.getPromise().then(function(){var e=t.nameConflictBehavior.peek();t.error(void 0);t.state(0);return t._enqueue().then(function(){t.state(1);return d.default.wrap(g(e))})})};e.prototype._enqueue=function(){var e=new p.default;this._queueBlocker=e;var t=new p.default(function(){e.cancel()});this._uploadQueue.enqueue(function(){t.complete();return e.getPromise()});return t.getPromise()};e.prototype._dequeue=function(){var e=this._queueBlocker;delete this._queueBlocker;e&&e.complete()};e.prototype._wait=function(e){var t,r=this,o=e.duration,a=e.allowWakeWhenOnline,i=void 0!==a&&a,n=new p.default(function(){r.async.clearTimeout(t)}),s=function(){i&&n.complete()};t=this.async.setTimeout(function(){n.complete()},o);this.events.on(window,"online",s);return n.getPromise().then(function(){r.events.off(window,"online",s)},function(e){r.events.off(window,"online",s);return d.default.wrapError(e)})};e.prototype._getUploadError=function(e){return new i.UploadError({message:e.message,errorType:function(e){var t=c.getErrorResolution(e,function(e){switch(e){case"authFailure":case"unauthenticated":case 401:return l.UploadErrorType.authFailure;case"pathIsTooLong":return l.UploadErrorType.pathTooLong;case"pathIsTooDeep":case"invalidPath":case"nameContainsInvalidCharacters":return l.UploadErrorType.invalidName;case"itemNotFound":case 404:return l.UploadErrorType.targetFolderMissing;case"activityLimitReached":return l.UploadErrorType.throttled;case"accessRestricted":case"accessDenied":case"notSupported":case 403:case 429:return l.UploadErrorType.accessDenied;case"nameAlreadyExists":case 409:return l.UploadErrorType.conflict;case"entityTagDoesNotMatch":case"versionNumberDoesNotMatch":case"resourceModified":case 412:return l.UploadErrorType.versionMismatch;case"maxFileSizeExceeded":case 413:return l.UploadErrorType.fileSize;case 415:return l.UploadErrorType.emptyFileOrFolder;case"lockMismatch":case"lockNotFoundOrAlreadyExpired":case"lockOwnerMismatch":case 423:return l.UploadErrorType.lockMismatch;case"maxDocumentCountExceeded":case"maxFolderCountExceeded":case"maxItemCountExceeded":case"quotaLimitReached":case 507:return l.UploadErrorType.overQuota;case"malwareDetected":case"virusSuspicious":return l.UploadErrorType.malwareDetected;case"timeout":case"generalException":case"invalidRange":case"invalidRequest":case"notAllowed":case"resyncRequired":case"serviceNotAvailable":case"uploadSessionNotFound":case 400:case 405:case 411:case 422:case 500:case 501:case 503:return}});void 0===t&&(t=l.UploadErrorType.general);return t}(e),allowRename:this.allowRename,extraData:c.getQosExtraDataFromError(e)})};e.dependencies=s.__assign({},r.default.dependencies,{vroomUploader:n.resourceKey,uploadQueue:t.uploadQueueResourceKey,itemResultProcessor:f.resourceKey,itemTaskObserverType:h.resourceKey,graphDataSource:m.graph});return e}(r.default);t.SingleFileUploader=v;function g(e){var t;switch(e){case 1:case 3:t="replace";break;case 2:t="rename";break;default:case 0:t="fail"}return t}t.resourceKey=new a.ResourceKey({name:e("module").id,factory:new a.ResolvedResourceTypeFactory(v)});t.default=v});define("@ms/odsp-graph/lib/Models",["require","exports","tslib","./models/error/Error"],function(e,t,r,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});r.__exportStar(o,t)});define("odsp-next/dataSources/upload/vroom/VroomUploader",["require","exports","@ms/odsp-graph/lib/services/upload/Upload","../../base/vroom/VroomDataRequestor","../../../utilities/features/Features","@ms/odsp-utilities/lib/resources/Resources"],function(e,t,r,o,a,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=new i.ResourceKey({name:e("module").id+".maximumFragmentSize",factory:new i.ConstantResourceFactory(a.isFeatureEnabled(a.EnableStreamingUpload)?251658240:void 0)});t.performanceNowResourceKey=new i.ResourceKey({name:e("module").id+".performanceNow",factory:new i.ConstantResourceFactory(r.performanceNow)});t.vroomUploadServiceResourceKey=new i.ResourceKey({name:e("module").id+".vroomUploadService",factory:new i.ResolvedResourceFactory(r.UploadService,{dataRequestor:o.resourceKey})});t.useCommitForVroomUploadResourceKey=new i.ResourceKey({name:e("module").id+".useCommitForVroomUpload",factory:new i.ConstantResourceFactory(a.isFeatureEnabled(a.UseCommitForVroomUpload))});t.useStreamingUploadResourceKey=new i.ResourceKey({name:e("module").id+".useStreamingUpload",factory:new i.ConstantResourceFactory(a.isFeatureEnabled(a.EnableStreamingUpload))});t.activityBandwidthVerifierTypeResourceKey=new i.ResourceKey({name:e("module").id+".activityBandwidthVerifier",factory:new i.ResolvedResourceTypeFactory(r.ActivityBandwidthVerifier,{performanceNow:t.performanceNowResourceKey})});t.vroomUploadStateMachineResourceKey=new i.ResourceKey({name:e("module").id+".vroomUploadStateMachine",factory:new i.ResolvedResourceFactory(r.UploadStateMachine,{uploadService:t.vroomUploadServiceResourceKey,activityBandwidthVerifierType:t.activityBandwidthVerifierTypeResourceKey,useCommitForUpload:t.useCommitForVroomUploadResourceKey,maximumFragmentSize:n})});t.resourceKey=i.createResolvedResourceKey(e("module").id,r.Uploader,{uploadService:t.vroomUploadServiceResourceKey,uploadStateMachine:t.vroomUploadStateMachineResourceKey,useStreamingUpload:t.useStreamingUploadResourceKey});t.default=r.Uploader});define("@ms/odsp-graph/lib/services/upload/Upload",["require","exports","tslib","./Uploader","./UploadService","./UploadStateMachine","./ActivityBandwidthVerifier"],function(e,t,r,o,a,i,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});r.__exportStar(o,t);r.__exportStar(a,t);r.__exportStar(i,t);r.__exportStar(n,t)});define("@ms/odsp-graph/lib/services/upload/Uploader",["require","exports","tslib","@ms/odsp-utilities/lib/async/Promise","../../models/error/Error","@ms/odsp-utilities/lib/logging/events/Qos.event"],function(e,t,i,s,n,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){var r=t.uploadService,o=t.uploadStateMachine,a=t.useStreamingUpload,i=void 0!==a&&a;this._uploadService=r;this._uploadStateMachine=o;this._useStreamingUpload=i}e.prototype.upload=function(e){var t=e.conflictBehavior,r=i.__rest(e,["conflictBehavior"]),o=r.qosData,a=new l.Qos({name:"VroomUploader.upload",extraData:o});return this._uploadState(r,{conflictBehavior:t,allowStreaming:this._useStreamingUpload}).then(function(e){a.end({resultType:l.ResultTypeEnum.Success});return e},function(e){a.end({resultType:s.default.isCanceled(e)?l.ResultTypeEnum.ExpectedFailure:l.ResultTypeEnum.Failure,error:e.message,resultCode:n.getResultCodeFromError(e),extraData:i.__assign({},o,n.getQosExtraDataFromError(e))});return s.default.reject(e)})};e.prototype._uploadState=function(t,e){var r=this,o=e.sessionUrl,a=e.item,i=e.error;if(a)return s.default.resolve(a);if(i){var n=void 0;o&&(n=this._uploadService.cancelSession({qosData:t.qosData,sessionUrl:o}).then(function(){},function(){}));return s.default.resolve(n).then(function(){return s.default.reject(i)})}return this._uploadStateMachine.advanceState(t,e).then(function(e){return r._uploadState(t,e)})};return e}();t.Uploader=r;t.default=r});define("@ms/odsp-graph/lib/services/upload/UploadService",["require","exports","tslib","@ms/odsp-utilities/lib/async/Signal"],function(e,t,m,f){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){this._dataRequestor=t.dataRequestor}e.prototype.createSession=function(e){var t=e.qosData,r=e.itemUrl,o=e.accessToken,a=e.fileName,i=e.fileSize,n=e.lastModifiedDate,s=e.eTag,l=e.conflictBehavior,u={item:m.__assign({},p(r)?{"@microsoft.graph.conflictBehavior":l}:{"@name.conflictBehavior":l},{fileSystemInfo:{lastModifiedDateTime:n?n.toISOString():void 0}})},d=m.__assign({},s?{"If-Match":s}:{},{Prefer:"synchronousmetadata"});return this._dataRequestor.send({path:r+"/"+encodeURIComponent(a)+":/"+(p(r)?"createUploadSession":"oneDrive.createUploadSession"),requestType:"POST",apiName:"CreateSession",headers:d,accessToken:o,useAuthorizationHeaders:!0,postData:JSON.stringify(u),qosExtraData:m.__assign({conflictBehavior:l,fileSize:i},t)})};e.prototype.cancelSession=function(e){var t=e.qosData,r=e.sessionUrl;return this._dataRequestor.send({requestType:"DELETE",apiName:"CancelSession",path:r,needsAuthorization:!1,qosExtraData:t})};e.prototype.uploadFragment=function(e){var t=e.qosData,r=e.sessionUrl,o=e.startByte,a=e.endByte,i=e.fileSize,n=e.content,s=e.timeout,l=e.onProgress,u={"Content-Range":"bytes "+o+"-"+Math.max(a-1,o)+"/"+i},d=!0,p=this._dataRequestor.send({path:r,needsAuthorization:!1,requestType:"PUT",apiName:"UploadFragment",headers:u,postData:n,timeout:s,onUploadProgress:function(e){e.lengthComputable&&d&&l(o+e.loaded)},qosExtraData:m.__assign({},t,{startByte:o,endByte:a,fileSize:i})}),c=new f.default(function(){d=!1;p.cancel()});p.done(function(e){d=!1;c.complete(e)},function(e){d=!1;c.error(e)});return c.getPromise()};e.prototype.commit=function(e){var t=e.qosData,r=e.itemUrl,o=e.accessToken,a=e.fileName,i=(e.description,e.eTag),n=e.conflictBehavior,s=e.sessionUrl,l={"If-Match":i},u=p(r)?{"@microsoft.graph.conflictBehavior":n,"@microsoft.graph.sourceUrl":s}:{"@name.conflictBehavior":n,"@content.sourceUrl":s};return this._dataRequestor.send({path:r+"/"+encodeURIComponent(a),requestType:"PUT",apiName:"CommitSession",headers:l,accessToken:o,useAuthorizationHeaders:!0,postData:JSON.stringify(u),qosExtraData:m.__assign({conflictBehavior:n},t)})};e.prototype.getStatus=function(e){var t=e.qosData,r=e.sessionUrl;return this._dataRequestor.send({requestType:"GET",apiName:"GetStatus",path:r,needsAuthorization:!1,qosExtraData:t})};e.prototype.getItem=function(e){var t=e.qosData,r=e.itemUrl,o=e.accessToken,a=e.fileName;return this._dataRequestor.send({requestType:"GET",apiName:"GetItem",path:r+"/"+encodeURIComponent(a),useAuthorizationHeaders:!0,accessToken:o,qosExtraData:m.__assign({},t)})};return e}();t.UploadService=r;function p(e){return 0===e.toLowerCase().lastIndexOf("https://graph.microsoft.com",0)}});define("@ms/odsp-graph/lib/services/upload/UploadStateMachine",["require","exports","tslib","../../models/error/Error","@ms/odsp-utilities/lib/logging/events/Qos.event","@ms/odsp-utilities/lib/async/Promise","@ms/odsp-utilities/lib/async/Signal"],function(e,t,T,E,b,s,R){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var F=1/1920,w=Math.pow(2,.25),r=function(){function e(e,t){this._uploadService=t.uploadService;this._activityBandwidthVerifierType=t.activityBandwidthVerifierType;var r=t.useCommitForUpload,o=void 0!==r&&r,a=t.checkForCompletedUploadOnSessionTermination,i=void 0===a||a,n=t.maximumFragmentSize,s=void 0===n?62914560:n;this._useCommitForUpload=o;this._checkForCompletedUploadOnSessionTermination=i;this._maximumFragmentSize=s}e.prototype.advanceState=function(t,e){var r=this,o=e.sessionUrl,a=e.nextExpectedRanges;return(o?a?this._uploadItemState(t,e):this._getStatusState(t,e):this._createSessionState(t,e)).then(function(e){return e.error?r._handleGeneralErrorState(t,e):r._getState(e,{waitDuration:void 0,attemptsRemaining:void 0})})};e.prototype._createSessionState=function(e,r){var o=this,a=e.qosData,i=new b.Qos({name:"VroomUploader.createSession",extraData:a});return this._uploadService.createSession({qosData:a,itemUrl:e.itemUrl,accessToken:e.accessToken,fileName:e.fileName,fileSize:e.content.size,eTag:e.eTag,lastModifiedDate:e.lastModifiedDate,conflictBehavior:r.conflictBehavior}).then(function(e){i.end({resultType:b.ResultTypeEnum.Success});return o._getState(r,{nextExpectedRanges:e.nextExpectedRanges,sessionUrl:e.uploadUrl})},function(t){return o._handleCreateSessionErrorState(e,o._getState(r,{error:t})).then(function(e){e.error?i.end({resultType:b.ResultTypeEnum.Failure,error:t.message,resultCode:E.getResultCodeFromError(t),extraData:T.__assign({},a,E.getQosExtraDataFromError(t))}):i.end({resultType:b.ResultTypeEnum.ExpectedFailure,resultCode:"Canceled"});return e})})};e.prototype._handleCreateSessionErrorState=function(r,o){var a=this;return this._handleErrorState(o,function(e,t){switch(e){case"entityTagDoesNotMatch":case"resourceModified":case"versionNumberDoesNotMatch":case"nameAlreadyExists":case"unlockRequired":case 409:case 412:return a._promptForConflictBehaviorState(t,r,o)}})};e.prototype._getStatusState=function(e,t){var r=this,o=e.qosData,a=new b.Qos({name:"VroomUploader.getStatus",extraData:o});return this._uploadService.getStatus({qosData:o,sessionUrl:t.sessionUrl}).then(function(e){a.end({resultType:b.ResultTypeEnum.Success});return r._getState(t,{nextExpectedRanges:e.nextExpectedRanges})},function(e){a.end({resultType:b.ResultTypeEnum.Failure,error:e.message,resultCode:E.getResultCodeFromError(e),extraData:T.__assign({},o,E.getQosExtraDataFromError(e))});return r._getState(t,{error:e})})};e.prototype._uploadItemState=function(t,e){var r=this,o=t.qosData,a=t.content.size,i=this._getNextRange({fileSize:a,nextExpectedRanges:e.nextExpectedRanges}),n=new b.Qos({name:"VroomUploader.uploadItem",extraData:t.qosData});return(i&&i.start<a?e.allowStreaming?this._uploadStreamState({nextRange:i},t,e):this._uploadFragmentState({nextRange:i},t,e):this._useCommitForUpload?this._commitState(t,e):this._cancelSessionState(t,e)).then(function(e){if(e.error)return r._handleUploadItemErrorState(t,e).then(function(e){var t=e.error;t?n.end({resultType:b.ResultTypeEnum.Failure,error:t.message,resultCode:E.getResultCodeFromError(t),extraData:T.__assign({},o,E.getQosExtraDataFromError(t))}):n.end({resultType:b.ResultTypeEnum.Success});return e});n.end({resultType:b.ResultTypeEnum.Success});return e})};e.prototype._uploadFragmentState=function(e,t,r){var o=this,a=e.nextRange,i=t.onProgress,n=t.content,s=t.content.size,l=t.qosData,u=r.sessionUrl,d=r.speed,p=void 0===d?1/8:d,c=a.start,m=a.end;i&&i(c);var f,h,y=this._getFragmentSize(p),_=Math.min(c+y,m),v=new R.default(function(){f&&f.cancel()}),g=F<p?6e4:3e5,S=new this._activityBandwidthVerifierType({timeout:g,totalBytes:_-c}),U=new b.Qos({name:"VroomUploader.uploadFragment",extraData:T.__assign({},l,{startByte:c,endByte:_,fileSize:s,speed:p,fragmentSize:y})});(f=this._uploadService.uploadFragment({qosData:l,sessionUrl:u,startByte:c,endByte:_,fileSize:s,content:n.slice(c,_),timeout:g,onProgress:function(e){h=e;if(F<p&&!S.doesActivityHaveRemainingCapacity(e-c)){U.end({resultType:b.ResultTypeEnum.ExpectedFailure,resultCode:"Aborted",extraData:T.__assign({},l,{lastByte:e})});v.complete(o._getState(r,{speed:Math.max(.5*p,F),nextExpectedRanges:void 0}));f&&f.cancel()}i&&i(e)}}).then(function(e){i&&i(_);U.end({resultType:b.ResultTypeEnum.Success});return r=o._isItem(e)?o._getState(r,{item:e}):o._getState(r,{nextExpectedRanges:e.nextExpectedRanges,speed:Math.min(S.didActivityHaveExtraCapacity()?p*w:p,1)})},function(e){U.end({resultType:b.ResultTypeEnum.Failure,error:e.message,resultCode:E.getResultCodeFromError(e),extraData:T.__assign({},l,E.getQosExtraDataFromError(e),{lastByte:h})});return o._getState(r,{error:e})})).done(function(e){v.complete(e)});return v.getPromise()};e.prototype._uploadStreamState=function(e,t,r){var o=this,a=e.nextRange,i=t.onProgress,n=t.content,s=t.content.size,l=t.qosData,u=r.sessionUrl,d=a.start,p=a.end,c=Math.min(p-d,this._maximumFragmentSize),m=d+c;i&&i(d);var f,h=new R.default(function(){f&&f.cancel()}),y=new b.Qos({name:"VroomUploader.uploadStream",extraData:T.__assign({},l,{startByte:d,endByte:m,fileSize:s,fragmentSize:c})});(f=this._uploadService.uploadFragment({qosData:l,sessionUrl:u,startByte:d,endByte:m,fileSize:s,content:n.slice(d,m),timeout:864e5,onProgress:function(e){i&&i(e)}}).then(function(e){i&&i(m);y.end({resultType:b.ResultTypeEnum.Success});return r=o._isItem(e)?o._getState(r,{item:e}):o._getState(r,{nextExpectedRanges:e.nextExpectedRanges})},function(e){y.end({resultType:b.ResultTypeEnum.Failure,error:e.message,resultCode:E.getResultCodeFromError(e),extraData:T.__assign({},l,E.getQosExtraDataFromError(e),{lastByte:void 0})});return o._handleUploadStreamErrorState({nextRange:a},t,o._getState(r,{error:e}))})).done(function(e){h.complete(e)});return h.getPromise()};e.prototype._handleUploadStreamErrorState=function(e,t,r){var o=this,a=e.nextRange;return this._handleErrorState(r,function(e){switch(e){case 0:return o._wait({duration:1e3},t).then(function(){return o._getStatusState(t,r).then(function(e){return o._getNextRange({fileSize:t.content.size,nextExpectedRanges:e.nextExpectedRanges}).start>a.start?e:o._getState(r,{allowStreaming:!1})})})}})};e.prototype._commitState=function(e,r){var o=this,a=e.qosData,t=e.onProgress;t&&t(e.content.size);var i=new b.Qos({name:"VroomUploader.commit",extraData:a});return this._uploadService.commit({qosData:a,itemUrl:e.itemUrl,accessToken:e.accessToken,fileName:e.fileName,sessionUrl:r.sessionUrl,conflictBehavior:r.conflictBehavior}).then(function(e){i.end({resultType:b.ResultTypeEnum.Success});return o._getState(r,{item:e})},function(t){return o._handleCommitErrorState(o._getState(r,{error:t})).then(function(e){i.end({resultType:e.error?b.ResultTypeEnum.Failure:b.ResultTypeEnum.ExpectedFailure,error:t.message,resultCode:E.getResultCodeFromError(t),extraData:T.__assign({},a,E.getQosExtraDataFromError(t))});return e})})};e.prototype._handleCommitErrorState=function(t){var r=this;return this._handleErrorState(t,function(e){switch(e){case"uploadSessionFailed":case"uploadSessionNotFound":case 410:return s.default.resolve(r._getState(t,{error:void 0,sessionUrl:void 0}))}})};e.prototype._cancelSessionState=function(e,t){var r=this,o=e.qosData,a=new b.Qos({name:"VroomUploader.cancelSession",extraData:o});return this._uploadService.cancelSession({qosData:e.qosData,sessionUrl:t.sessionUrl}).then(function(){a.end({resultType:b.ResultTypeEnum.Success});return r._getState(t,{sessionUrl:void 0})},function(e){a.end({resultType:b.ResultTypeEnum.Failure,error:e.message,resultCode:E.getResultCodeFromError(e),extraData:T.__assign({},o,E.getQosExtraDataFromError(e))});return r._getState(t,{sessionUrl:void 0})})};e.prototype._handleUploadItemErrorState=function(r,o){var a=this,e=o.speed,i=void 0===e?1:e;o=this._getState(o,{nextExpectedRanges:void 0});return this._handleErrorState(o,function(e,t){switch(e){case 0:return window.navigator.onLine?o.allowStreaming?s.default.resolve(a._getState(o,{allowStreaming:!1})):s.default.resolve(a._getState(o,{speed:Math.max(i*(1/8),F)})):void 0;case"uploadSessionFailed":case"uploadSessionNotFound":case 404:return s.default.resolve(a._getState(o,{error:void 0,sessionUrl:void 0}));case"entityTagDoesNotMatch":case"resourceModified":case"versionNumberDoesNotMatch":case"nameAlreadyExists":case"unlockRequired":case 409:case 412:return a._promptForConflictBehaviorState(t,r,o);case"invalidRange":case 416:return a._wait({duration:1e3},r).then(function(){return a._getState(o,{error:void 0})})}})};e.prototype._getItemIfCompletedState=function(t,r){var o=this,a=t.qosData,i=new b.Qos({name:"VroomUploader.getItemIfCompleted",extraData:a});return this._uploadService.getItem({qosData:a,fileName:t.fileName,itemUrl:t.itemUrl,accessToken:t.accessToken}).then(function(e){i.end({resultType:b.ResultTypeEnum.Success});return t.lastModifiedDate&&e.fileSystemInfo&&e.fileSystemInfo.lastModifiedDateTime===t.lastModifiedDate.toISOString()&&e.size===t.content.size&&"rename"!==r.conflictBehavior?o._getState(r,{item:e,error:void 0}):o._getState(r,{error:new Error("The upload session has terminated but the existing item does not match the input.")})},function(e){i.end({resultType:b.ResultTypeEnum.Failure,error:e.message,resultCode:E.getResultCodeFromError(e),extraData:T.__assign({},a,E.getQosExtraDataFromError(e))});return o._getState(r,{error:e})})};e.prototype._handleGeneralErrorState=function(t,r){var o=this,e=r.waitDuration,a=void 0===e?500:e,i=r.attemptsRemaining,n=void 0===i?10:i;return this._handleErrorState(r,function(e){switch(e){case"uploadSessionNotFound":return o._checkForCompletedUploadOnSessionTermination?o._getItemIfCompletedState(t,r):void 0;case"authFailure":case"unauthenticated":case 401:case"lockMismatch":case 423:case 501:case"quotaLimitReached":case 507:return}if("number"==typeof e){if(400<=e&&e<500)return;if(0===e||500<=e&&e<600)return o._wait({duration:a,allowWakeWhenOnline:!0},t).then(function(){return o._getState(r,{error:void 0,waitDuration:Math.min(2*a,3e4),attemptsRemaining:void 0})});if(!n)return;return o._wait({duration:1e3},t).then(function(){return o._getState(r,{error:void 0,waitDuration:void 0,attemptsRemaining:Math.max(n-1,0)})})}})};e.prototype._handleErrorState=function(e,t){var r=e.error,o=E.getErrorResolution(r,t);void 0===o&&(o=s.default.resolve(e));return o};e.prototype._promptForConflictBehaviorState=function(t,e,r){var o=this,a=e.onPromptForConfictBehavior,i=e.qosData,n=new b.Qos({name:"VroomUploader.promptForConflictBehavior",extraData:i});return s.default.resolve().then(function(){return a(t)}).then(function(e){n.end({resultType:b.ResultTypeEnum.Success,extraData:i});return o._getState(r,{error:void 0,conflictBehavior:e})},function(e){n.end({resultType:b.ResultTypeEnum.Failure,error:e.message,resultCode:E.getResultCodeFromError(t),extraData:T.__assign({},i,E.getQosExtraDataFromError(e))});return o._getState(r,{error:e})})};e.prototype._wait=function(e,t){var r=e.duration,o=e.allowWakeWhenOnline,a=t.onWait,i=t.qosData,n=new b.Qos({name:"VroomUploader.wait",extraData:i});return s.default.resolve(a({duration:r,allowWakeWhenOnline:o})).then(function(){n.end({resultType:b.ResultTypeEnum.Success})},function(e){n.end({resultType:s.default.isCanceled(e)?b.ResultTypeEnum.Success:b.ResultTypeEnum.Failure,error:e&&e.message,resultCode:E.getResultCodeFromError(e)});return s.default.reject(e)})};e.prototype._getState=function(e,t){return T.__assign({},e,t)};e.prototype._getNextRange=function(e){var s=e.fileSize,t=e.nextExpectedRanges;return(void 0===t?[]:t).reduce(function(e,t){var r,o=t.split("-",2),a=o[0],i=o[1],n=parseInt(a,10);if(!e||n<e.start&&n<s){r={start:n,end:""===i?s:Math.min(parseInt(i,10)+1,s)}}else r=e;return r},void 0)};e.prototype._isItem=function(e){return!!e.id};e.prototype._getFragmentSize=function(e){var t,r=62914560*e;t=327680<r?r-r%327680:r-r%32768;return Math.min(Math.max(t,32768),this._maximumFragmentSize)};return e}();t.UploadStateMachine=r});define("@ms/odsp-graph/lib/services/upload/ActivityBandwidthVerifier",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.performanceNow=window.performance?function(){return window.performance.now()}:function(){return Date.now()};var r=function(){function e(e,t){this._performanceNow=t.performanceNow;this._startTime=this._performanceNow();this._expirationTime=this._startTime+e.timeout;this._totalBytes=e.totalBytes;this._progressPoints=0}e.prototype.doesActivityHaveRemainingCapacity=function(e){var t=this._getRateRatio(e);return void 0===t||t<=1};e.prototype.didActivityHaveExtraCapacity=function(){return this._getRateRatio(this._totalBytes)<=.5};e.prototype._getRateRatio=function(e){this._progressPoints++;var t,r=this._performanceNow(),o=r-this._startTime,a=this._expirationTime-r,i=this._totalBytes-e;(4<=this._progressPoints&&4e3<=o||0<this._progressPoints&&0===i)&&0<a&&(t=i/a/(e/o));return t};return e}();t.ActivityBandwidthVerifier=r});define("odsp-next/dataSources/base/odc/vroom/ItemIdentityProcessor",["require","exports","../../../item/ItemTaskObserver","@ms/odsp-utilities/lib/resources/Resources","../../../../resources/DataSourceResourceKeys","@ms/odsp-utilities/lib/graft/Graft"],function(e,t,m,r,o,f){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){var r=t.urlDataSource;this._urlDataSource=r}e.prototype.processIdentity=function(e){var t,r,o,a,i=e.itemFromServer,n=e.observer,s=i.parentReference,l=i.id,u=i.root?"root":l,d=this._urlDataSource.getKey(((o={}).id=u,o));if(s){var p=s.id,c=s.path;t=this._urlDataSource.getKey(((a={}).id=(r=c)&&r.lastIndexOf("/root:")===r.length-"/root:".length?"root":p,a))}n.update([new m.Task(d).succeed({item:{key:d,id:u,parentKey:f.optional(t)}})]);return{key:d}};e.dependencies={urlDataSource:o.url};return e}();t.ItemIdentityProcessor=a;t.resourceKey=r.createResolvedResourceKey(e("module").id,a);t.default=a});define("odsp-next/dataSources/graph/odc/GraphDataSource",["require","exports","@ms/odsp-datasources/lib/utilities/permissions/Identity","@ms/odsp-shared/lib/utilities/navigation/Navigation.key","@ms/odsp-utilities/lib/async/Promise","@ms/odsp-utilities/lib/resources/Resources","../../base/vroom/VroomDataRequestor","cookies","../../../resources/DataSourceResourceKeys"],function(e,t,r,o,d,a,i,p,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){this._identityDataSource=t.identityDataSource;this._navigation=t.navigation;this._urlDataSource=t.urlDataSource;this._urlCache=new Map;this._vroomDataRequestor=t.vroomDataRequestor}e.prototype.getDownloadUrl=function(r,e){void 0===e&&(e={});var o=this._urlCache,t=o.get(r.key)||{},a=t.url,i=t.time;if(a&&i<Date.now()-27e5)return d.default.wrap(a);var n=this._getAuthKey(),s=this.getItemUrl(r,e),l={};if(n){var u=p.get("BadgerAuth");u&&(l={Authorization:"Badger "+u})}return this._vroomDataRequestor.send({apiName:"itemDownloadUrl",path:s+"?select=id,@content.downloadUrl"+(n?"&authkey="+n:""),needsAuthorization:!n,headers:l}).then(function(e){var t=e["@content.downloadUrl"];o.set(r.key,{url:t,time:Date.now()});return t})};e.prototype.getDownloadUrlSync=function(e,t){var r=this.getItemUrl(e,t),o=this._getAuthKey();return r&&o?r+"/content?authkey="+o:void 0};e.prototype.getAuthenticationParams=function(e){var t,r=this._getAuthKey();return r?d.default.resolve(((t={}).authkey=r,t)):this._identityDataSource.getSessionToken().then(function(e){var t=e.accessToken,r=e.proofToken,o={};t&&(o.access_token=decodeURIComponent(t));r&&(o.prooftoken=decodeURIComponent(r));return o})};e.prototype.getDriveUrl=function(e,t){void 0===t&&(t={});var r=t.useDirectEndpoint,o=void 0!==r&&r,a=this._getGraphFacet(e);return this._getDriveUrl(a,o)};e.prototype.getItemUrl=function(e,t){void 0===t&&(t={});var r=t.useDirectEndpoint,o=void 0!==r&&r,a=t.isPath,i=void 0!==a&&a,n=this._getGraphFacet(e);return this._getDriveUrl(n,o)+"/items/"+encodeURIComponent(n.itemId)+(i?":":"")};e.prototype.getAccessToken=function(e){};e.prototype._getAuthKey=function(){return this._identityDataSource.getIdentity().type===r.IdentityType.anonymous&&this._navigation.viewParams.authkey};e.prototype._getGraphFacet=function(e){var t=e.graph;if(t)return t;var r=this._urlDataSource.getKeyParams(e.key);return{itemId:r.id,driveId:r.cid}};e.prototype._getDriveUrl=function(e,t){return(t?this._urlDataSource.getApiBaseUrl():"https://graph.microsoft.com/v1.0")+"/drives/"+encodeURIComponent(e.driveId)};e.dependencies={identityDataSource:n.identity,navigation:o.navigation,urlDataSource:n.url,vroomDataRequestor:i.resourceKey};return e}();t.default=s;t.resourceKey=a.createResolvedResourceKey(e("module").id,s)});